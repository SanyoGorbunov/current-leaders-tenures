<html>
    <head>
        <title>Current Leaders Tenures</title>

        <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
        <script src="https://cdn.amcharts.com/lib/5/map.js"></script>
        <script src="https://cdn.amcharts.com/lib/5/geodata/worldLow.js"></script>
        <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
        <script src="./countries.js"></script>
        <script src="./leaders.js"></script>

        <style type="text/css">
            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            }

            #chartdiv {
                width: 100%;
            }
        </style>
    </head>
    <body>
        <div id="chartdiv"></div>

        <script>
            function monthDiff(dateFrom, dateTo) {
                return dateTo.getMonth() - dateFrom.getMonth() + 
                    (12 * (dateTo.getFullYear() - dateFrom.getFullYear()))
            }

            function getCountryHeatMap() {
                
                var heatmap = []

                countries.forEach(country => {
                    var records = leaders.filter(leaderRecord => leaderRecord.state === country.name);

                    if (records.length > 0) {

                        var earliestDate = new Date()
                        records.forEach(record => {
                            if (new Date(record.date) < earliestDate) {
                                earliestDate = new Date(record.date);
                            }
                        });

                        var months = monthDiff(earliestDate, new Date());
                        heatmap.push({
                            id: country.code,
                            value: months > 180 ? 180 : months,
                            years: Math.round(months / 12.0 * 10) / 10
                        })
                    }

                });

                return heatmap;
            }

            // Create root and chart
            var root = am5.Root.new("chartdiv"); 

            // Set themes
            root.setThemes([
                am5themes_Animated.new(root)
            ]);

            var chart = root.container.children.push(
                am5map.MapChart.new(root, {
                    panX: "rotateX",
                    projection: am5map.geoNaturalEarth1()
                })
            );

            // Create polygon series
            var polygonSeries = chart.series.push(
                am5map.MapPolygonSeries.new(root, {
                    geoJSON: am5geodata_worldLow,
                    exclude: ["AQ"],
                    valueField: "value",
                    calculateAggregates: true
                })
            );

            polygonSeries.mapPolygons.template.setAll({
                tooltipText: "{name} {years}"
            });

            polygonSeries.set("heatRules", [{
                target: polygonSeries.mapPolygons.template,
                dataField: "value",
                min: am5.color(0xff621f),
                max: am5.color(0x661f00),
                key: "fill"
            }]);

            polygonSeries.data.setAll(getCountryHeatMap());
        </script>
    </body>
</html>